<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.x/dist/index.umd.js"></script>
        <meta charset="utf-8"/>
        <style>
            body {
                margin: 0;
                padding: 0;
                height: 100vh; /* Set the height to 100% of the viewport height */
                background: linear-gradient(to bottom, #FFB6C1, #FF8FAA);
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            }

            .commands-container {
                position: fixed;
                bottom: 50px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 20px;
            }

            main {
                width: 100vw;
                height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #letter-container {
                font-size: 200px;
                color: red;
                width: 80vw;
                max-width: 600px;
                text-align: center;
                min-height: 200px;
                cursor: pointer;
            }

            .previous-letters { opacity: 0.3; }
            .subsequent-letters { opacity: 0.05; }

            header {
                position: fixed;
                left: 0;
                right: 0;
                top: 20px;
                margin: 0 auto;
                display: flex;
                justify-content: center;
            }

            #points-container {
                position: fixed;
                right: 50px;
                top: 50px;
                font-size: 40px;
            }

            #numberOfLettersSelector, #startButton {
                font-size: 26px;
            }

            #fireworks-container {
                display: none;
            }

            #fireworks-container.shown {
                display: block;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                right: 0;
            }
        </style>
    </head>
    <body>
        <header>
            <select id="numberOfLettersSelector">
                <option>random</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
            </select>
            <button id="startButton">start</button>
        </header>
        <main>
            <div id="letter-container">start</div>
        </main>
        
        <div class="commands-container"></div>
        <div id="points-container"></div>
        <div id="fireworks-container"></div>

        <script>
            const letterContainer = document.querySelector("#letter-container");
            
            async function playLetters(text){
                var value = text.trim();

                for(let i = 0; i < value.length; i++){
                    const previous = value.substring(0, i);
                    const currentLetter = value[i];
                    const subsequent = value.substring(i + 1);
                    await displayText(previous, currentLetter, subsequent);
                }

                displayWord(value);
            }

            function displayText(previous, current, subsequent){
                return new Promise((resolve) => {
                    letterContainer.innerHTML = `
                        <span class='previous-letters'>${previous}</span><span>${current}</span><span class='subsequent-letters'>${subsequent}</span>
                    `;
                    
                    timeout = setTimeout(() => {
                        resolve(true);
                    }, 200);
                });
            }
 
            let currentWordCounter = 0;
            let isRecording = false;
            let points = 0;
            let targetPoints = 1200;

            function showPoints(){
                document.getElementById("points-container").textContent = `${points}/${targetPoints}`;
                if(points >= targetPoints){
                    showFireworks();
                }
            }

            let fireworks;
                function showFireworks(){
                    const container = document.querySelector('#fireworks-container');
                    container.classList.add("shown");
                    fireworks = new Fireworks.default(container, {
                        sound: {
                            enabled: true,
                            files: [
                                'sound/explosions/explosion0.mp3',
                                'sound/explosions/explosion1.mp3',
                                'sound/explosions/explosion2.mp3'
                            ],
                            volume: {
                                min: 4,
                                max: 8
                            }
                        }
                    });
                    fireworks.start();

                    setTimeout(() => {
                        hideFireworks();
                    }, 10000);
                }

                function hideFireworks(){
                    const container = document.querySelector('#fireworks-container');
                    container.classList.add("shown");
                    fireworks.stop(true);
                }
            
            (async () => {
                const data = await (await fetch("wordsAndSylablles.json")).json();

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const SpeechGrammarList = window.SpeechGrammarList || window.webkitSpeechGrammarList;
                const SpeechRecognitionEvent = window.SpeechRecognitionEvent || window.webkitSpeechRecognitionEvent;

                function createSpeechRecognition(){
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.lang = "hr";
                    recognition.interimResults = true;
                    recognition.maxAlternatives = 10;

                    return recognition;
                }

                function sleep(number){
                    return new Promise((resolve, reject) => {
                        setTimeout(resolve, number);
                    });
                }

                async function displayWordAndStartSpeechRecognition(word){
                    let startTime = new Date();
                    setTimeout(() => {
                        letterContainer.textContent = word;
                        startTime = new Date();
                    }, 250);
                    
                    const result = await recognizeWord(word);
                    const endTime = new Date();
                    
                    if(result){
                        const duration = (endTime - startTime)/1000;
                        let newPoints = 0;
                        
                        if(duration < 1){ newPoints = 50; }
                        else if(duration < 1.5) {  newPoints = 40; }
                        else if(duration < 2) {  newPoints = 30; }
                        else if(duration < 3) {  newPoints = 20; }
                        else if(duration < 4) {  newPoints = 10; }
                        else {  newPoints = 5; }

                        newPoints *= word.length;

                        points += newPoints;
                        showPoints();

                        confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }});
                        letterContainer.textContent = "";
                    
                        await sleep(500);
                    
                        goToNextWord();
                    }
                }

                const recognition = createSpeechRecognition();

                async function recognizeWord(word){
                    if(isRecording && recognition != null){
                        recognition.abort();
                        await sleep(500);
                    }
                    
                    word = word.toLowerCase();
                    let failCounter = 0;
                    return new Promise((resolve, reject) => {
                        const processRecognition = (event) => {
                            if(!event.results || event.results.length == 0) { return; }
                            
                            const lastResult = event.results[event.results.length - 1];
                            for(const item of lastResult){
                                const transcript = item.transcript.toLowerCase();
                                
                                if(!transcript){
                                    failCounter++;
                                    if(failCounter > 1){
                                        console.log("restarting");
                                        recognition.removeEventListener("result", processRecognition);
                                        recognition.abort();
                                        resolve(false);
                                        isRecording = false;
                                        setTimeout(() => repeatWord(), 300);
                                    }
                                }
                                else {
                                    failCounter = 0;
                                }
                                
                                console.log(item.transcript, item.confidence);
                                
                                if(transcript == word
                                || transcript.split(/\s+/).indexOf(word) >= 0){
                                    recognition.removeEventListener("result", processRecognition);
                                    recognition.abort();

                                    resolve(true);
                                    isRecording = false;
                                    return;
                                }

                                if(transcript == "dalje"
                                || transcript.split(/\s+/).indexOf("dalje") >= 0){
                                    recognition.removeEventListener("result", processRecognition);
                                    recognition.abort();
                                    resolve(false);
                                    isRecording = false;
                                    setTimeout(() => goToNextWord(), 250);
                                    
                                    return;
                                }
                            }
                        }

                        recognition.addEventListener("result", processRecognition);

                        recognition.onend = e => {
                            isRecording = false;
                            resolve(false);
                        }

                        recognition.start();
                        isRecording = true;
                    });
                }

                function getRandomNumber(lowend, highend){
                    return Math.floor(Math.random() * highend) + lowend;
                }

                function getCurrentWordsBank(){
                    let lettersCount = document.querySelector("#numberOfLettersSelector").value;
                    if(lettersCount == "random"){
                        lettersCount = getRandomNumber(3, 8);
                    }
                    
                    return data.words[lettersCount] || getCurrentWordsBank();
                }

                document.querySelector("#numberOfLettersSelector").addEventListener("change", () => {
                    const wordsBank = getCurrentWordsBank();
                    
                    if(wordsBank){
                        currentWordCounter = 0;
                        displayWordAndStartSpeechRecognition(wordsBank[currentWordCounter].word);
                    }
                });

                document.querySelector("#startButton").addEventListener("click", startNewGame);

                function startNewGame(){
                    points = 0;
                    
                    showPoints(0);
                    
                    const wordsBank = getCurrentWordsBank();
                    
                    if(wordsBank){
                        currentWordCounter = 0;
                        displayWordAndStartSpeechRecognition(wordsBank[currentWordCounter].word);
                    }
                }

                function repeatWord(){
                    displayWordAndStartSpeechRecognition(letterContainer.textContent);
                }

                function goToNextWord(){
                    const wordsBank = getCurrentWordsBank();
                    if(wordsBank){
                        currentWordCounter++;
                        if(!wordsBank[currentWordCounter]){
                            currentWordCounter = 0;
                        }
                        
                        displayWordAndStartSpeechRecognition(wordsBank[currentWordCounter].word);
                    }
                }

                function goToPreviousWord(){
                    const wordsBank = getCurrentWordsBank();
                    if(wordsBank){
                        currentWordCounter--;
                        if(currentWordCounter < 0){
                            currentWordCounter = wordsBank.length - 1;
                        }
                        
                        displayWordAndStartSpeechRecognition(wordsBank[currentWordCounter].word);
                    }
                }

                document.addEventListener("keydown", e => {
                    if(e.which == 39 || e.which == 32) { // -> or space
                        goToNextWord();
                    }
                    else if(e.which == 37){// <-
                        goToPreviousWord();
                    }
                    else if(e.which == 13){
                        startNewGame();
                    }
                    else if(e.key == "f"){
                        showFireworks();
                    }
                });

                document.querySelector("#letter-container").addEventListener("click", function(){
                    goToNextWord();
                });
                
                startNewGame();
            })();
        </script>
    </body>
</html>